name: Build and Deploy to Maven Central

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'website/**'
  schedule:
    - cron: '0 0 * * 0'  # Run every Sunday at midnight UTC
  workflow_dispatch:
    inputs:
      cache_mode:
        description: |
          Cache Strategy:
          ‚Ä¢ normal = Use all caches (fastest, recommended)
          ‚Ä¢ rebuild-jfr = Re-run JFR benchmarks, keep JDK downloads
          ‚Ä¢ rebuild-all = Fresh start, re-download everything
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - rebuild-jfr
          - rebuild-all

# Prevent concurrent deployments to avoid conflicts
concurrency:
  group: maven-deployment
  cancel-in-progress: false

env:
  # Java LTS version - update here when new LTS is released
  # Current LTS: 21 (Sep 2023 - Sep 2031)
  # Next LTS: 25 (Sep 2025 - Sep 2033) - coming soon
  JAVA_VERSION: '25'

jobs:
  # Job 1: Prepare for JFR creation
  prepare-jfr:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      gc-options: ${{ steps.gc-options.outputs.options }}
      gc-matrix: ${{ steps.gc-matrix.outputs.matrix }}
      cache-mode: ${{ steps.determine-cache-mode.outputs.mode }}
      should-create-jfr: ${{ steps.check-jfr-needed.outputs.needed }}

    steps:
      - name: Validate required secrets
        run: |
          echo "Validating required secrets are configured..."
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.MAVEN_USERNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}MAVEN_USERNAME "
          fi
          if [ -z "${{ secrets.MAVEN_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}MAVEN_PASSWORD "
          fi
          if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}GPG_PRIVATE_KEY "
          fi
          if [ -z "${{ secrets.GPG_KEYNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}GPG_KEYNAME "
          fi
          if [ -z "${{ secrets.GPG_PASSPHRASE }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}GPG_PASSPHRASE "
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå ERROR: Missing required secrets: $MISSING_SECRETS"
            echo "Please configure these secrets in repository settings"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured"

      - name: Determine cache mode
        id: determine-cache-mode
        run: |
          # Fix null cache_mode for non-manual triggers
          CACHE_MODE="${{ github.event.inputs.cache_mode }}"
          if [ -z "$CACHE_MODE" ]; then
            CACHE_MODE="normal"
          fi
          echo "mode=$CACHE_MODE" >> $GITHUB_OUTPUT
          echo "Cache mode: $CACHE_MODE"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'sapmachine'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get current month for cache key
        id: cache-month
        run: |
          CURRENT_MONTH=$(date +'%Y-%m')
          LAST_MONTH=$(date -d '1 month ago' +'%Y-%m' 2>/dev/null || date -v-1m +'%Y-%m')
          echo "month=$CURRENT_MONTH" >> $GITHUB_OUTPUT
          echo "last-month=$LAST_MONTH" >> $GITHUB_OUTPUT
          echo "Current month: $CURRENT_MONTH"
          echo "Last month: $LAST_MONTH"

      - name: Get Java version for cache key
        id: java-version
        run: |
          JAVA_VER=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "version=$JAVA_VER" >> $GITHUB_OUTPUT
          echo "Java version: $JAVA_VER"

      - name: Get GC options
        id: gc-options
        run: |
          chmod +x bin/releaser.py
          GC_OPTIONS=$(bin/releaser.py list_gc_options)
          echo "options=$GC_OPTIONS" >> $GITHUB_OUTPUT
          echo "Available GC options: $GC_OPTIONS"

      - name: Check cached JFR files per GC
        id: check-gc-cache
        if: ${{ steps.determine-cache-mode.outputs.mode == 'normal' }}
        run: |
          GC_OPTIONS="${{ steps.gc-options.outputs.options }}"
          CACHE_MONTH="${{ steps.cache-month.outputs.month }}"
          LAST_MONTH="${{ steps.cache-month.outputs.last-month }}"
          JAVA_VER="${{ steps.java-version.outputs.version }}"
          
          echo "Checking per-GC cache status..."
          MISSING_GCS=""
          
          for gc in $GC_OPTIONS; do
            echo "Checking cache for $gc..."
            # Note: We'll actually restore these in the parallel job
            # Here we just track which ones might be missing
            MISSING_GCS="$MISSING_GCS $gc"
          done
          
          # For now, we'll let the parallel job handle individual cache checks
          echo "gc-list=$GC_OPTIONS" >> $GITHUB_OUTPUT
          echo "Per-GC cache checking complete"

      - name: Determine GCs to build
        id: gcs-to-build
        run: |
          CACHE_MODE="${{ steps.determine-cache-mode.outputs.mode }}"
          GC_OPTIONS="${{ steps.gc-options.outputs.options }}"
          
          if [ "$CACHE_MODE" == "rebuild-jfr" ] || [ "$CACHE_MODE" == "rebuild-all" ]; then
            echo "Rebuild mode - all GCs need to be built"
            echo "gcs=$GC_OPTIONS" >> $GITHUB_OUTPUT
            echo "needed=true" >> $GITHUB_OUTPUT
          elif [ "$CACHE_MODE" == "normal" ]; then
            # In normal mode, we'll check individual caches in parallel job
            echo "Normal mode - checking individual GC caches in parallel jobs"
            echo "gcs=$GC_OPTIONS" >> $GITHUB_OUTPUT
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "gcs=$GC_OPTIONS" >> $GITHUB_OUTPUT
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if JFR creation needed
        id: check-jfr-needed
        run: |
          if [ "${{ steps.gcs-to-build.outputs.needed }}" == "true" ]; then
            echo "needed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ JFR creation needed"
          else
            echo "needed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è JFR creation not needed (all caches hit)"
          fi

      - name: Create GC matrix
        id: gc-matrix
        if: steps.check-jfr-needed.outputs.needed == 'true'
        run: |
          # Convert space-separated list to JSON array for matrix (compact format)
          GC_OPTIONS="${{ steps.gcs-to-build.outputs.gcs }}"
          JSON_ARRAY=$(echo $GC_OPTIONS | jq -R -c 'split(" ")')
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
          echo "Matrix: $JSON_ARRAY"

      - name: Build JFC configuration
        if: steps.check-jfr-needed.outputs.needed == 'true'
        env:
          LOG: "true"  # Enable verbose logging for better error diagnostics
        run: |
          echo "Building JFC configuration file (prevents concurrent generation issues)..."
          bin/releaser.py build_jfc
          echo "‚úÖ JFC configuration ready"

      - name: Upload JFC and Renaissance JAR
        if: steps.check-jfr-needed.outputs.needed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: jfc-config
          path: |
            .cache/jfc.jfc
            .cache/renaissance.jar
          retention-days: 1

  # Job 2: Create JFR files in parallel
  create-jfr-parallel:
    needs: prepare-jfr
    if: needs.prepare-jfr.outputs.should-create-jfr == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        gc: ${{ fromJSON(needs.prepare-jfr.outputs.gc-matrix) }}
      fail-fast: false  # Continue other GCs even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'sapmachine'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get cache key info
        id: cache-info
        run: |
          JAVA_VER=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          CURRENT_MONTH=$(date +'%Y-%m')
          LAST_MONTH=$(date -d '1 month ago' +'%Y-%m' 2>/dev/null || date -v-1m +'%Y-%m')
          echo "java-version=$JAVA_VER" >> $GITHUB_OUTPUT
          echo "month=$CURRENT_MONTH" >> $GITHUB_OUTPUT
          echo "last-month=$LAST_MONTH" >> $GITHUB_OUTPUT

      - name: Restore cached JFR for ${{ matrix.gc }}
        id: jfr-cache
        if: needs.prepare-jfr.outputs.cache-mode == 'normal'
        uses: actions/cache@v4
        with:
          path: jfr/sample_${{ matrix.gc }}.jfr
          key: jfr-${{ matrix.gc }}-${{ steps.cache-info.outputs.month }}-java${{ steps.cache-info.outputs.java-version }}
          restore-keys: |
            jfr-${{ matrix.gc }}-${{ steps.cache-info.outputs.month }}-
            jfr-${{ matrix.gc }}-${{ steps.cache-info.outputs.last-month }}-

      - name: Download JFC configuration
        if: steps.jfr-cache.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: jfc-config
          path: .cache/

      - name: Create JFR for ${{ matrix.gc }}
        if: steps.jfr-cache.outputs.cache-hit != 'true'
        env:
          GC: ${{ matrix.gc }}
          LOG: "true"  # Enable verbose logging for better error diagnostics
        run: |
          set -e
          chmod +x bin/releaser.py
          echo "========================================="
          echo "Creating JFR for GC: ${{ matrix.gc }}"
          echo "========================================="
          bin/releaser.py create_jfr 2>&1 | tee create_jfr_${{ matrix.gc }}.log
          
          if [ $? -ne 0 ]; then
            echo "‚ùå JFR creation failed for ${{ matrix.gc }}!"
            echo "Last 50 lines of output:"
            tail -n 50 create_jfr_${{ matrix.gc }}.log
            exit 1
          fi
          
          echo "‚úÖ JFR file created for ${{ matrix.gc }}"

      - name: Report cache hit
        if: steps.jfr-cache.outputs.cache-hit == 'true'
        run: |
          echo "========================================="
          echo "‚úÖ Cache hit for ${{ matrix.gc }}"
          echo "Skipping JFR creation"
          echo "========================================="

      - name: Upload JFR creation log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: jfr-creation-log-${{ matrix.gc }}-${{ github.run_number }}
          path: create_jfr_${{ matrix.gc }}.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload JFR file
        uses: actions/upload-artifact@v4
        with:
          name: jfr-${{ matrix.gc }}
          path: jfr/sample_${{ matrix.gc }}.jfr
          retention-days: 1

  # Job 3: Build artifacts (combines JFR files and builds)
  build:
    needs: [prepare-jfr, create-jfr-parallel]
    if: always() && needs.prepare-jfr.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      cache-mode: ${{ needs.prepare-jfr.outputs.cache-mode }}
      java-version: ${{ env.JAVA_VERSION }}

    steps:
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          # Remove unnecessary pre-installed software to free up space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'sapmachine'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get current month for cache key
        id: cache-month
        run: |
          CURRENT_MONTH=$(date +'%Y-%m')
          LAST_MONTH=$(date -d '1 month ago' +'%Y-%m' 2>/dev/null || date -v-1m +'%Y-%m')
          echo "month=$CURRENT_MONTH" >> $GITHUB_OUTPUT
          echo "last-month=$LAST_MONTH" >> $GITHUB_OUTPUT

      - name: Get Java version for cache key
        id: java-version
        run: |
          JAVA_VER=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "version=$JAVA_VER" >> $GITHUB_OUTPUT
          echo "Java version: $JAVA_VER"

      - name: Restore .cache folder
        if: ${{ needs.prepare-jfr.outputs.cache-mode != 'rebuild-all' }}
        uses: actions/cache@v4
        with:
          path: .cache
          key: jfr-cache-${{ steps.cache-month.outputs.month }}-java${{ steps.java-version.outputs.version }}
          restore-keys: |
            jfr-cache-${{ steps.cache-month.outputs.month }}-
            jfr-cache-${{ steps.cache-month.outputs.last-month }}-

      - name: Cache Maven dependencies (excluding local artifacts)
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository/*
            !~/.m2/repository/me/bechberger
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml', '**/pom_loader.xml') }}-v2
          restore-keys: |
            maven-${{ runner.os }}-${{ hashFiles('**/pom.xml', '**/pom_loader.xml') }}-
            maven-${{ runner.os }}-
          enableCrossOsArchive: false

      - name: Verify Maven cache
        run: |
          if [ -d ~/.m2/repository ]; then
            echo "‚úÖ Maven cache restored"
            du -sh ~/.m2/repository || true
          else
            echo "‚ö†Ô∏è Maven cache not found, will download dependencies"
          fi

      - name: Pre-fetch Maven dependencies
        continue-on-error: true
        run: |
          echo "Pre-fetching Maven dependencies in parallel..."
          # Download dependencies for all modules without building
          # This populates the cache faster by using parallel downloads
          mvn dependency:go-offline -T 1C -B -q 2>/dev/null || \
          mvn dependency:resolve -T 1C -B -q 2>/dev/null || \
          echo "‚ö†Ô∏è Dependency pre-fetch had some issues, continuing with build..."
          echo "‚úÖ Maven dependency pre-fetch completed"

      - name: Download JFR files from parallel jobs
        if: needs.prepare-jfr.outputs.should-create-jfr == 'true'
        uses: actions/download-artifact@v4
        with:
          pattern: jfr-*
          path: jfr-artifacts/
          merge-multiple: false

      - name: Consolidate JFR files
        if: needs.prepare-jfr.outputs.should-create-jfr == 'true'
        run: |
          echo "Consolidating JFR files from parallel jobs (cached and newly created)..."
          mkdir -p jfr
          # Move all JFR files from individual artifacts to jfr folder
          find jfr-artifacts -name "*.jfr" -exec mv {} jfr/ \;
          ls -lh jfr/
          echo "‚úÖ JFR files consolidated"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Import and validate GPG key
        run: |
          set -e
          echo "Importing GPG private key..."
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          echo "Validating GPG key import..."
          if ! gpg --list-secret-keys --keyid-format LONG | grep -q "${{ secrets.GPG_KEYNAME }}"; then
            echo "‚ùå ERROR: GPG key ${{ secrets.GPG_KEYNAME }} not found after import"
            echo "Available keys:"
            gpg --list-secret-keys --keyid-format LONG
            exit 1
          fi
          
          echo "‚úÖ GPG key successfully imported and validated"
          gpg --list-secret-keys --keyid-format LONG "${{ secrets.GPG_KEYNAME }}"

      - name: Configure GPG for Maven
        run: |
          echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent
          echo "‚úÖ GPG configured for Maven signing"

      - name: Create minimal Maven settings (using env vars)
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings>
            <servers>
              <server>
                <id>ossrh</id>
                <username>${env.MAVEN_USERNAME}</username>
                <password>${env.MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>gpg</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                  <gpg.executable>gpg</gpg.executable>
                  <gpg.keyname>${env.GPG_KEYNAME}</gpg.keyname>
                  <gpg.passphrase>${env.GPG_PASSPHRASE}</gpg.passphrase>
                  <!-- Performance optimizations -->
                  <maven.artifact.threads>8</maven.artifact.threads>
                  <maven.resolver.transport>wagon</maven.resolver.transport>
                </properties>
              </profile>
            </profiles>
          </settings>
          EOF
          echo "‚úÖ Maven settings.xml created (references env vars, no secrets on disk)"

      - name: Download JDK sources
        timeout-minutes: 20
        env:
          LOG: "true"  # Enable verbose logging for better error diagnostics
        run: |
          set -e
          set -o pipefail
          chmod +x bin/releaser.py
          echo "========================================="
          echo "Downloading JDK sources..."
          echo "========================================="
          bin/releaser.py download 2>&1 | tee download.log
          echo "‚úÖ JDK sources downloaded successfully"


      - name: Build artifacts
        timeout-minutes: 20
        env:
          # Pass credentials as environment variables (never written to disk)
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          LOG: "true"  # Enable verbose logging for better error diagnostics
        run: |
          set -e
          set -o pipefail
          
          echo "========================================="
          echo "Building artifacts..."
          echo "========================================="
          
          # Log environment info for debugging
          echo "Maven version:"
          mvn --version
          echo ""
          echo "Disk space:"
          df -h
          echo ""
          echo "Memory:"
          free -h || true
          echo ""
          
          # Build with verbose output
          bin/releaser.py build_parser 2>&1 | tee build_parser.log
          
          if [ $? -ne 0 ]; then
            echo "‚ùå build_parser failed!"
            echo "Last 100 lines of output:"
            tail -n 100 build_parser.log
            exit 1
          fi
          
          bin/releaser.py build_versions 2>&1 | tee build_versions.log
          
          if [ $? -ne 0 ]; then
            echo "‚ùå build_versions failed!"
            echo "Last 100 lines of output:"
            tail -n 100 build_versions.log
            exit 1
          fi
          
          bin/releaser.py build 2>&1 | tee build.log
          
          if [ $? -ne 0 ]; then
            echo "‚ùå build failed!"
            echo "Last 100 lines of output:"
            tail -n 100 build.log
            exit 1
          fi
          
          echo "========================================="
          echo "‚úÖ Build completed successfully"
          echo "========================================="

      - name: Extract version
        id: extract-version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            download.log
            build_parser.log
            build_versions.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jfr-artifacts-${{ steps.extract-version.outputs.version }}
          path: |
            target/*.jar
            target/*.xml
          retention-days: 7

      - name: Report cache statistics
        if: always()
        run: |
          echo "========================================="
          echo "Cache Statistics"
          echo "========================================="
          if [ -d ~/.m2/repository ]; then
            echo "Maven repository size:"
            du -sh ~/.m2/repository
            echo ""
            echo "Top 10 largest dependencies:"
            du -sh ~/.m2/repository/*/* 2>/dev/null | sort -hr | head -n 10 || echo "Unable to list dependencies"
          else
            echo "Maven repository not found"
          fi
          echo ""
          if [ -d .cache ]; then
            echo ".cache folder size:"
            du -sh .cache
            ls -lh .cache/ 2>/dev/null || true
          else
            echo ".cache folder not found"
          fi
          echo "========================================="

  # Job 2: Deploy to Maven Central
  deploy-maven:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'sapmachine'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven dependencies (excluding local artifacts)
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository/*
            !~/.m2/repository/me/bechberger
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml', '**/pom_loader.xml') }}-v2
          restore-keys: |
            maven-${{ runner.os }}-${{ hashFiles('**/pom.xml', '**/pom_loader.xml') }}-
            maven-${{ runner.os }}-
          enableCrossOsArchive: false

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: jfr-artifacts-${{ needs.build.outputs.version }}
          path: target/

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG "${{ secrets.GPG_KEYNAME }}"

      - name: Configure GPG for Maven
        run: |
          echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent

      - name: Create minimal Maven settings (using env vars)
        run: |
          # Create settings.xml that references environment variables
          # No secrets are written to disk - they're read from environment at runtime
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings>
            <servers>
              <server>
                <id>ossrh</id>
                <username>${env.MAVEN_USERNAME}</username>
                <password>${env.MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>gpg</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                  <gpg.executable>gpg</gpg.executable>
                  <gpg.keyname>${env.GPG_KEYNAME}</gpg.keyname>
                  <gpg.passphrase>${env.GPG_PASSPHRASE}</gpg.passphrase>
                  <!-- Performance optimizations -->
                  <maven.artifact.threads>8</maven.artifact.threads>
                  <maven.resolver.transport>wagon</maven.resolver.transport>
                </properties>
              </profile>
            </profiles>
          </settings>
          EOF
          echo "‚úÖ Maven settings.xml created (references env vars, no secrets on disk)"

      - name: Deploy to Maven Central
        env:
          # Pass credentials as environment variables
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -e
          chmod +x bin/releaser.py
          echo "Deploying to Maven Central..."
          bin/releaser.py deploy_mvn
          echo "‚úÖ Deployment completed"

  # Job 3: Verify deployment
  verify-deployment:
    needs: [build, deploy-maven]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Verify Maven Central deployment
        run: |
          set -e
          echo "========================================="
          echo "Verifying deployment to Maven Central..."
          echo "========================================="
          
          VERSION="${{ needs.build.outputs.version }}"
          echo "Checking for version: $VERSION"
          
          # Wait for Maven Central sync
          echo "Waiting 30 seconds for Maven Central sync..."
          sleep 30
          
          # Check for jfreventcollector artifact
          COLLECTOR_URL="https://s01.oss.sonatype.org/content/repositories/snapshots/me/bechberger/jfreventcollector/${VERSION}/"
          echo "Checking: $COLLECTOR_URL"
          
          if curl --head --fail --silent "$COLLECTOR_URL" > /dev/null 2>&1; then
            echo "‚úÖ jfreventcollector artifact found"
          else
            echo "‚ö†Ô∏è WARNING: jfreventcollector artifact not yet visible at $COLLECTOR_URL"
            echo "This may be normal - Maven Central can take a few minutes to index"
          fi
          
          # Check for jfreventcollection artifact
          COLLECTION_URL="https://s01.oss.sonatype.org/content/repositories/snapshots/me/bechberger/jfreventcollection/${VERSION}/"
          echo "Checking: $COLLECTION_URL"
          
          if curl --head --fail --silent "$COLLECTION_URL" > /dev/null 2>&1; then
            echo "‚úÖ jfreventcollection artifact found"
          else
            echo "‚ö†Ô∏è WARNING: jfreventcollection artifact not yet visible at $COLLECTION_URL"
            echo "This may be normal - Maven Central can take a few minutes to index"
          fi
          
          echo "========================================="
          echo "‚úÖ Deployment verification completed"
          echo "========================================="
          echo ""
          echo "üì¶ Artifacts should be available at:"
          echo "  - $COLLECTOR_URL"
          echo "  - $COLLECTION_URL"

  # Job 4: Update website
  update-website:
    needs: [build, verify-deployment]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Trigger website update
        run: |
          echo "Triggering website update workflow..."
          gh workflow run update-gh-pages.yml \
            --repo ${{ github.repository }} \
            --ref main
          echo "‚úÖ Website update workflow triggered"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Notify on completion
  notify:
    needs: [build, deploy-maven, verify-deployment, update-website]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create workflow summary
        run: |
          echo "# Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Mode**: ${{ needs.build.outputs.cache-mode || 'normal (auto)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy**: ${{ needs.deploy-maven.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verify**: ${{ needs.verify-deployment.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Website**: ${{ needs.update-website.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.deploy-maven.result }}" == "success" ] && \
             [ "${{ needs.verify-deployment.result }}" == "success" ]; then
            echo "## ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the failed jobs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployed Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [jfreventcollector](https://s01.oss.sonatype.org/content/repositories/snapshots/me/bechberger/jfreventcollector/${{ needs.build.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [jfreventcollection](https://s01.oss.sonatype.org/content/repositories/snapshots/me/bechberger/jfreventcollection/${{ needs.build.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resources" >> $GITHUB_STEP_SUMMARY
          echo "- [Maven Central Snapshots](https://s01.oss.sonatype.org/content/repositories/snapshots/me/bechberger/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Website](https://sap.github.io/jfrevents/)" >> $GITHUB_STEP_SUMMARY

      - name: Report success
        if: needs.build.result == 'success' && needs.deploy-maven.result == 'success' && needs.verify-deployment.result == 'success'
        run: |
          echo "========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "========================================="
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "========================================="

      - name: Report failure
        if: needs.build.result != 'success' || needs.deploy-maven.result != 'success' || needs.verify-deployment.result != 'success'
        run: |
          echo "========================================="
          echo "‚ùå DEPLOYMENT FAILED"
          echo "========================================="
          echo "Build: ${{ needs.build.result }}"
          echo "Deploy: ${{ needs.deploy-maven.result }}"
          echo "Verify: ${{ needs.verify-deployment.result }}"
          echo "Website: ${{ needs.update-website.result }}"
          echo "========================================="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "========================================="
          exit 1